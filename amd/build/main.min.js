define(["jquery","core/ajax","core/notification","core/modal_factory","core/str"],function(c,b,d,a,e){return{debug:false,sync_queue_create:[],sync_queue_purge:[],sync_queue_roles:[],selectAutoenrol:function(i,h){var g=this;if(g.debug){console.log("local_webuntis/main:selectAutoenrol(uniqid, courseid)",i,h)}var f=c("#triggerenrol_"+i+"_"+h+" i");c(f).css("filter","blur(4px)");var j=(c(f).hasClass("fa-toggle-on"))?0:1;if(g.debug){console.log("setto",j)}b.call([{methodname:"local_webuntis_autoenrol",args:{courseid:h,status:j},done:function(k){c(f).css("filter","unset");if(g.debug){console.log("=> Result for "+i+"-"+h,k)}if(typeof k.courseid!=="undefined"&&k.courseid==h&&typeof k.status!=="undefined"){if(g.debug){console.log("===> status",k.status)}if(k.status==1){c(f).removeClass("fa-toggle-off").addClass("fa-toggle-on")}else{c(f).removeClass("fa-toggle-on").addClass("fa-toggle-off")}}if(typeof k.canproceed!=="undefined"){if(g.debug){console.log("===> canproceed",k.canproceed)}if(k.canproceed==1){c("#proceed-"+i).removeClass("disabled")}else{c("#proceed-"+i).addClass("disabled")}}},fail:d.exception}])},selectTarget:function(i,h){var g=this;if(g.debug){console.log("local_webuntis/main:selectTarget(uniqid, courseid)",i,h)}var f=c("#trigger_"+i+"_"+h+" i");c(f).css("filter","blur(4px)");var j=(c(f).hasClass("fa-toggle-on"))?0:1;if(g.debug){console.log("setto",j)}b.call([{methodname:"local_webuntis_selecttarget",args:{courseid:h,status:j},done:function(k){c(f).css("filter","unset");if(g.debug){console.log("=> Result for "+i+"-"+h,k)}if(typeof k.courseid!=="undefined"&&k.courseid==h&&typeof k.status!=="undefined"){if(g.debug){console.log("===> status",k.status)}if(k.status==1){c(f).removeClass("fa-toggle-off").addClass("fa-toggle-on");c("#triggerenrol_"+i+"_"+h).removeClass("hidden")}else{c(f).removeClass("fa-toggle-on").addClass("fa-toggle-off");c("#triggerenrol_"+i+"_"+h).addClass("hidden")}}if(typeof k.canproceed!=="undefined"){if(g.debug){console.log("===> canproceed",k.canproceed)}if(k.canproceed==1){c("#proceed-"+i).removeClass("disabled")}else{c("#proceed-"+i).addClass("disabled")}}if(typeof k.autoenrol!=="undefined"){if(g.debug){console.log("===> autoenrol",k.autoenrol)}if(k.autoenrol==1){c("#triggerenrol_"+i+"_"+h+" i").removeClass("fa-toggle-off").addClass("fa-toggle-on")}else{c("#triggerenrol_"+i+"_"+h+" i").removeClass("fa-toggle-on").addClass("fa-toggle-off")}}},fail:d.exception}])},setAutoCreate:function(i){var h=this;if(h.debug){console.log("local_webuntis/main:setAutoCreate(uniqid)",i)}var f=c("#autocreate-"+i);var g=c(f).find("i.fa");c(g).css("filter","blur(4px)");var j=(c(g).hasClass("fa-toggle-on"))?0:1;if(h.debug){console.log("setto",j)}b.call([{methodname:"local_webuntis_autocreate",args:{status:j},done:function(k){c(g).css("filter","unset");if(h.debug){console.log("=> Result for "+i,k)}if(typeof k.status!=="undefined"){if(h.debug){console.log("===> status",k.status)}if(k.status==1){c(g).removeClass("fa-toggle-off").addClass("fa-toggle-on")}else{c(g).removeClass("fa-toggle-on").addClass("fa-toggle-off")}}},fail:d.exception}])},tenantData:function(f){var g=this;if(g.debug){console.log("local_webuntis/main:tenantData(sender)",f)}var k=c(f).closest("tr");var m=k.attr("data-tenant_id");if(typeof m=="undefined"||m==""){a.create({type:a.types.OK,title:"Exception",body:"No Tenant ID for this input",}).then(function(n){n.show()});return}var l=c(f).attr("data-field");var j=c(f).val();var i=c(f).attr("data-compare");if(j==i){return}c(f).css("filter","blur(4px)");var h={tenant_id:m,field:l,value:j};if(g.debug){console.log("Sending",h)}b.call([{methodname:"local_webuntis_tenantdata",args:h,done:function(n){c(f).css("filter","unset");if(g.debug){console.log("=> Result",n)}if(n.status!=1){c(f).addClass("alert-danger");setTimeout(function(){c(f).removeClass("alert-danger")},1000)}else{c(f).attr("data-compare",j);c(f).addClass("alert-success");setTimeout(function(){c(f).removeClass("alert-success")},1000);c(f).removeClass("alert-danger");if(l=="tenant_id"){k.attr("data-tenant_id",j)}}if(typeof n.message!=="undefined"&&n.message!=""){a.create({type:a.types.OK,title:"Exception",body:n.message,}).then(function(o){o.show()})}},fail:d.exception}])},usersync_create:function(k,h){if(this.debug){console.log("local_webuntis/main::usersync_create(uniqid, item)",k,h)}var g=this;if(typeof(h)==="undefined"){c("."+k+" .m_doit:checked").each(function(){g.sync_queue_create.push({uniqid:k,item:this})});if(g.sync_queue_create.length>0){var f=g.sync_queue_create.shift();g.usersync_create(f.uniqid,f.item)}}else{c(h).css("filter","blur(2px)");var j=c(h).closest("tr");var i=j.attr("data-remoteuserid");b.call([{methodname:"local_webuntis_usersync_create",args:{remoteuserid:i},done:function(l){c(h).css("filter","unset");if(g.debug){console.log("=> Result for "+k+"-"+i,l)}if(l.userid>0){var n=c('<span style="color: green;">').html(l.message);c(h).parent().empty().append(n)}if(g.sync_queue_create.length>0){var m=g.sync_queue_create.shift();g.usersync_create(m.uniqid,m.item)}},fail:d.exception}])}},usersync_purge:function(j,h){if(this.debug){console.log("local_webuntis/main::usersync_purge(uniqid, item)",j,h)}var g=this;if(typeof(h)==="undefined"){e.get_strings([{key:"admin:usersync:userpurge:confirm:title",component:"local_webuntis"},{key:"admin:usersync:userpurge:confirm:text",component:"local_webuntis"},{key:"proceed"},{key:"cancel"},]).done(function(l){d.confirm(l[0],l[1],l[2],l[3],function(){c("."+j+" .m_doit:checked").each(function(){g.sync_queue_purge.push({uniqid:j,item:this})});if(g.sync_queue_purge.length>0){var m=g.sync_queue_purge.shift();g.usersync_purge(m.uniqid,m.item)}})}).fail(d.exception)}else{c(h).css("filter","blur(2px)");var i=c(h).closest("tr");var f=i.attr("data-userid");var k=i.attr("data-orgid");b.call([{methodname:"local_webuntis_usersync_purge",args:{userid:f,orgid:k},done:function(l){c(h).css("filter","unset");if(g.debug){console.log("=> Result for "+j+"-"+f,l)}if(l.status>0){var n=c('<span style="color: green;">').html(l.message);c(h).parent().empty().append(n)}if(g.sync_queue_purge.length>0){var m=g.sync_queue_purge.shift();g.usersync_purge(m.uniqid,m.item)}},fail:d.exception}])}},usersync_roles:function(j,h){if(this.debug){console.log("local_webuntis/main::usersync_roles(uniqid, item)",j,h)}var g=this;if(typeof(h)==="undefined"){e.get_strings([{key:"admin:usersync:userroles:confirm:title",component:"local_webuntis"},{key:"admin:usersync:userroles:confirm:text",component:"local_webuntis"},{key:"proceed"},{key:"cancel"},]).done(function(m){d.confirm(m[0],m[1],m[2],m[3],function(){c("."+j+" .m_doit:checked").each(function(){g.sync_queue_roles.push({uniqid:j,item:this})});if(g.sync_queue_roles.length>0){var n=g.sync_queue_roles.shift();g.usersync_roles(n.uniqid,n.item)}})}).fail(d.exception)}else{c(h).css("filter","blur(2px)");var i=c(h).closest("tr");var f=i.attr("data-userid");var l=i.attr("data-orgid");var k=i.find(".w_role").html().replace("Administrator","Manager");b.call([{methodname:"local_webuntis_usersync_roles",args:{userid:f,orgid:l,role:k},done:function(m){c(h).css("filter","unset");if(g.debug){console.log("=> Result for "+j+"-"+f,m)}if(typeof(m.role)!=="undefined"){c(i).find(".sync-btn").empty();c(i).find(".m_role").css("color","green").html(m.role)}if(g.sync_queue_roles.length>0){var n=g.sync_queue_roles.shift();g.usersync_roles(n.uniqid,n.item)}},fail:d.exception}])}},}});